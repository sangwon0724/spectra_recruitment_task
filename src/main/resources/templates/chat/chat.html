<!DOCTYPE html>
<html
        lang="ko"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout/layout}"
>
    <th:block>
        <style layout:fragment="style">
            html, body {
                height: 100%;
                margin: 0;
                overflow: hidden;
            }

            .chat-wrapper {
                display: flex;
                height: 100vh;
            }

            .main-chat {
                width: 100%;
                display: flex;
                flex-direction: column;
                transition: width 0.3s;
            }

            .observer-chat {
                width: 0;
                overflow: hidden;
                background-color: #f1f3f5;
                border-left: 1px solid #ccc;
                transition: width 0.3s;
                display: flex;
                flex-direction: column;
            }

            .chat-list {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
            }

            .chat-message {
                margin-bottom: 0.75rem;
                max-width: 75%;
                padding: 0.5rem 1rem;
                border-radius: 0.75rem;
            }

            .chat-message.customer {
                background-color: #e9f5ff;
                align-self: flex-start;
            }

            .chat-message.agent {
                background-color: #d1e7dd;
                align-self: flex-end;
            }

            .chat-message.observer {
                background-color: #fff3cd;
                align-self: flex-start;
            }

            .input-area {
                padding: 0.75rem;
                border-top: 1px solid #ccc;
                display: flex;
                align-items: flex-end;
                height: 10vh;
                min-height: 4rem;
                transition: height 0.2s;
            }

            .chat-input {
                resize: none;
                border-radius: 0.5rem;
                width: 90%;
                height: 90%;
                padding: 0.5rem;
            }

            .input-button {
                width: 40px;
                height: 40px;
                margin-left: 0.5rem;
                border-radius: 50%;
                background-color: #0d6efd;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                flex-shrink: 0;
            }

            .chat-header {
                font-size: 0.8rem;
                font-weight: bold;
                margin-bottom: 0.25rem;
            }

            /* Scroll fix */
            textarea {
                overflow-y: auto;
            }
        </style>
    </th:block>
    <th:block layout:fragment="content">
        <div class="chat-wrapper">
            <!-- 메인 채팅 영역 -->
            <div class="main-chat" id="mainChat">
                <div class="chat-list" id="mainChatList">
                    <div class="chat-header">고객</div>
                    <div class="chat-message customer">안녕하세요, 문의드립니다.</div>
                    <div class="chat-header text-end">홍길동 상담사</div>
                    <div class="chat-message agent ms-auto">네, 무엇을 도와드릴까요?</div>
                </div>
                <div class="input-area" id="mainInputArea">
                    <textarea class="chat-input form-control" id="mainInput" rows="1" placeholder="메시지를 입력하세요..."></textarea>
                    <div class="input-button" onclick="toggleObserver()">＋</div>
                </div>
            </div>

            <!-- 옵저버 채팅 영역 -->
            <div class="observer-chat" id="observerChat">
                <div class="chat-list" id="observerChatList">
                    <div class="chat-header">옵저버</div>
                    <div class="chat-message observer">지켜보고 있습니다.</div>
                    <div class="chat-header text-end">홍길동 상담사</div>
                    <div class="chat-message agent ms-auto">이상 없습니다.</div>
                </div>
                <div class="input-area" id="observerInputArea">
                    <textarea class="chat-input form-control" id="observerInput" rows="1" placeholder="옵저버 메시지를 입력하세요..."></textarea>
                    <div class="input-button bg-danger" onclick="toggleObserver()">－</div>
                </div>
            </div>
        </div>
    </th:block>
    <th:block layout:fragment="script">
        <script>
            const mainInput = document.getElementById('mainInput');
            const mainInputArea = document.getElementById('mainInputArea');
            const observerInput = document.getElementById('observerInput');
            const observerInputArea = document.getElementById('observerInputArea');

            function autoResize(textarea, container) {
                textarea.style.height = 'auto';
                const newHeight = Math.min(textarea.scrollHeight, window.innerHeight * 0.35);
                textarea.style.height = newHeight + 'px';
                container.style.height = newHeight + 20 + 'px';
            }

            mainInput.addEventListener('input', () => autoResize(mainInput, mainInputArea));
            observerInput.addEventListener('input', () => autoResize(observerInput, observerInputArea));

            function toggleObserver() {
                const main = document.getElementById('mainChat');
                const observer = document.getElementById('observerChat');

                if (observer.style.width === '30%') {
                    // 줄이기
                    main.style.width = '100%';
                    observer.style.width = '0';
                } else {
                    // 열기
                    main.style.width = '70%';
                    observer.style.width = '30%';
                }
            }
            
            //const socket = new SockJS('/chat');
            //const stompClient = Stomp.over(socket);

            /*
            stompClient.connect({}, function () {
                stompClient.subscribe('/topic/messages', function (messageOutput) {
                    const message = JSON.parse(messageOutput.body);
                    console.log(message);
                });

                stompClient.send("/app/send", {}, JSON.stringify({
                    sender: "user1",
                    content: "Hello!"
                }));
            });
            */

        </script>
    </th:block>
</html>